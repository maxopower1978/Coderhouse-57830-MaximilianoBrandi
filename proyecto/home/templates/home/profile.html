{% extends 'home/base.html' %}

{% block header %}
    <div style="display: flex; justify-content: center; align-items: center; height: 5vh;">
        <h3 style="margin-bottom: 5px; font-family: 'Arial', sans-serif;">Perfil Usuario</h3>
    </div>
{% endblock header %}

{% block content %}
<div class="container mt-5 text-center">
    <h1>¡Perfil de Usuario!</h1>
    <li class="nav-item">
        <a class="btn btn-outline-primary mt-3" href="{% url 'profile' user.pk %}">Editar Perfil</a>
    </li>

    <div id="success-message" class="mt-3"></div>
    
    <h5>Tu Avatar:</h5>
    {% if user.userprofile.image %}
        <img src="{{ user.userprofile.image.url }}" alt="Avatar" id="user-avatar" class="img-fluid" style="max-width: 200px;">
    {% else %}
        <p>No tienes un avatar configurado.</p>
    {% endif %}
    
    <form id="avatar-form" method="post" action="{% url 'profile' user.pk %}" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}  
        <button type="submit" class="btn btn-primary">Actualizar Avatar</button>
    </form>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#avatar-form').on('submit', function(event) {
                event.preventDefault();
                
                const csrftoken = $("input[name='csrfmiddlewaretoken']").val();

                $.ajax({
                    type: 'POST',
                    url: $(this).attr('action'),  // Usa la acción del formulario que contiene el pk
                    data: new FormData(this),
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-CSRFToken': csrftoken
                    },
                    success: function(response) {
                        $('#success-message').html('<div class="alert alert-success">' + response.message + '</div>');
                        if (response.new_avatar_url) {
                            $('#user-avatar').attr('src', response.new_avatar_url);
                        }
                    },
                    error: function(response) {
                        $('#success-message').html('<div class="alert alert-danger">Error al actualizar el avatar.</div>');
                    }
                });
            });
        });
    </script>
</div>
{% endblock %}
